#!/bin/bash

fail() {
	echo -e "\nFAIL: $1\n"
	exit 2
}

pass() {
	echo -e "\nPASS: $1\n"
}

pr() {
	cd $WORKDIR;set -o vi
	if [ -z "$2" ];then echo "Resetting to Dev ?";else echo "Preparing PR $2 ?";fi
	read aaa1
    #git reset --hard develop
	git fetch && git checkout -f develop
	git pull
	git branch | grep -v "develop" | xargs git branch -D 2>&1 | egrep -v "^error: branch"
	if [ ! -z "$2" ];then
		git checkout $2
		git pull
		git merge -m "Merge develop" develop
	fi
	grep -r "<<<< HEAD" && fail "Address conflicts"
	pass "No conflicts"
	if ( git status | sed 1,6d | egrep -v ".csv$|.svg$|^# *$|^nothing added to commit..*$" );then fail "Found above files";fi
	pass "No unexpected files"
	./vendor/bin/phinx migrate -e ${qasite}
	grunt dist
	clearc
	echo -e "\nAll done\n"
}

reset() {
	cd $WORKDIR
	echo "Reset environment to dev if necessary";read zzz
	php cron/importCatalogueData.php
}

clearc() {
	(cd /tmp/templateCache/1/${qasite}.allbeauty.com && rm -rf * && echo -e "\n\nCached content $(ls -l)")
}

regen() {
	d1="$(date)"
	(cd /tmp/templateCache/1/${qasite}.allbeauty.com && rm -rf * && echo -e "\n\nCached content $(ls -l)")
	cd $WORKDIR
	rm -rf $WORKDIR/storage/dd_Algolia*
	php cron/generateProductAvailability.php
	php cron/regenerateCatalogues.php
	php cron/generateAlgoliaIndices.php force
	echo -e "Started: $d1\nStopped: $(date)"
}

# List files created or modified in last 60 mins
mod() {
     find . -cmin -60 -o -mmin -60
}

index() {
	cd $WORKDIR
	php cron/generateProductAvailability.php
    algolia
}

algolia() {
	INDICES="$WORKDIR/storage/dd_Algolia*"
	cd $WORKDIR
	rm -rf $INDICES
	find $INDICES 2>/dev/null && fail "$INDICES still remain"
    echo "Regenerating $(grep 'indexName' config.json) on https://www.algolia.com/apps/VS22L5JM4O/explorer/indices"
	php cron/generateAlgoliaIndices.php force
    clearc
}

logs() {
	clear
	echo "Last ten logs updated..."
	ls -ltr /var/log/httpd/* | tail -10
	errlog="$(ls -tr /var/log/httpd/* | grep "error" | tail -1)"
	echo -e "\n<CR> to tail (or 'O' to open) $errlog ?";read OtO
	[[ "$OtO" =~ ^(O|o)$ ]] && vim $errlog || (echo "Tailing..." && tail -f $errlog)
}

init() {
	sudo yum install vim
}
 
help() {
	declare -F | sed "s/^declare -f //g"
}

[ -z "$WORKDIR" ] && export WORKDIR=/home/deploy/toska #Default working directory
echo "Working dir = $WORKDIR"

$1 $@
